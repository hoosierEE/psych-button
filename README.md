Psych-Button
============
USB response boxes with real-time accuracy.

In many psychological experiments, researchers want to record subject responses to audio/video stimuli.  In many cases precise and accurate timing is required, and the operating system's time functions are inadequate.  The code in this repository showcases how to make a USB device capable of accurate timing.

The device has a single USB cable but shows up as *two* separate USB devices: a **USB Keyboard** and a **USB Serial** interface.  The keyboard is essentially the same as a standard USB keyboard with the exception that instead of 108 or more keys, it only has 4.  The Serial interface is where things start to get interesting.  This interface provides button press data but *also* precise timing data.

Recording data from the serial interface lets you calculate both the round-trip delay and the offset for the device+PC combo.

### Timing Measurements
Round-trip delay `d` is calculated as per the [SNTP protocol, section 5](https://tools.ietf.org/html/rfc4330#section-5):

    Timestamp Name          ID   When Generated
    ------------------------------------------------------------
    Originate Timestamp     T1   time request sent by client
    Receive Timestamp       T2   time request received by server
    Transmit Timestamp      T3   time reply sent by server
    Destination Timestamp   T4   time reply received by client

    The roundtrip delay d and system clock offset t are defined as:

    d = (T4 - T1) - (T3 - T2)     t = ((T2 - T1) + (T3 - T4)) / 2.

Timing measurement from `psych-button` uses a modified version of SNTP, where `psych-button` responds to a timing request with a single number that corresponds to T3-T2.  In this scheme, T2 is always 0.  T3 is measured in integer microseconds.  Offset is not used, because `psych-button` doesn't keep a wall clock time.  The only figure we're interested in is the round-trip delay.

This procedure is done at least once, usually before an experiment, but can be done at any point in time except during data collection.

    PC (note system time T1), send character: 'T'
    psych-button: T3
    PC (note time of reply T4, calculate d given T3, T2=0)

### Python pyserial example

    cd examples/
    python pythonExample.py

The results from this test is a list of 100 numbers, corresponding to timing measurements before (t1) sending a `T` and after (t2).  The plot below (generated by the [J](http://www.jsoftware.com/) script `examples/stats.ijs`) shows the results of one such test, highlighting the standard deviation (blue), variance (red), arithmetic mean (green) and differences (t2<sub>i</sub> - t1<sub>i</sub>, violet):

![](https://raw.githubusercontent.com/hoosierEE/psych-button/master/examples/round_trip_timing.png)

### Button Encoding
Since we have 4 buttons, we can represent "pressed" with a 1 and "not pressed" with a 0, and encode all 4 button values in a single byte:

| State                   | button 3 | button 2 | button 1 | button 0 | Keyboard representation |
|-------------------------|----------|----------|----------|----------|:-----------------------:|
| no buttons pressed      | 0        | 0        | 0        | 0        |                         |
| button 0 pressed        | 0        | 0        | 0        | 1        |      <kbd>w</kbd>       |
| button 1 pressed        | 0        | 0        | 1        | 0        |      <kbd>x</kbd>       |
| buttons 0 1 pressed     | 0        | 0        | 1        | 1        |                         |
| button 2 pressed        | 0        | 1        | 0        | 0        |      <kbd>y</kbd>       |
| buttons 0 2 pressed     | 0        | 1        | 0        | 1        |                         |
| buttons 1 2 pressed     | 0        | 1        | 1        | 0        |                         |
| buttons 0 1 2 pressed   | 0        | 1        | 1        | 1        |                         |
| button 3 pressed        | 1        | 0        | 0        | 0        |      <kbd>z</kbd>       |
| buttons 0 3 pressed     | 1        | 0        | 0        | 1        |                         |
| (etc.)                  | 1        | 0        | 1        | 0        |                         |
| (etc.)                  | 1        | 0        | 1        | 1        |                         |
| (etc.)                  | 1        | 1        | 0        | 0        |                         |
| (etc.)                  | 1        | 1        | 0        | 1        |                         |
| (etc.)                  | 1        | 1        | 1        | 0        |                         |
| all buttons pressed     | 1        | 1        | 1        | 1        |                         |

Serial interface updates whenever there is a change in the state of any button (either pressed or released).

The Keyboard interface sends a `keydown` event followed by a `keyup` event when a button is first pressed.

Usage (Keyboard)
----------------
To use a response box as a USB keyboard, plug and play.  By default, the 4 buttons correspond to <kbd>w</kbd>, <kbd>a</kbd>, <kbd>s</kbd>, and <kbd>d</kbd> keyboard events.  Open a text editor and use the response box to "type" letters.

| button | key          |
|--------|:------------:|
| 0      | <kbd>w</kbd> |
| 1      | <kbd>x</kbd> |
| 2      | <kbd>y</kbd> |
| 3      | <kbd>z</kbd> |

Usage (Serial)
--------------
To use the serial interface, open a serial terminal on your computer using a program such as [pyserial](https://github.com/pyserial/pyserial).  Use the following settings:

* 115200 baud
* 8 data bits
* no parity
* 1 stop bit

Pressing and holding the `b0` button (and no others) will result in one line of output:

    1 0 0 0

Meanwhile, if you press the `b3` button, while continuing to hold `b0`, the next output will be:

    1 0 0 1

Finally, releasing the `b3` button, then releasing the `b0` button, will produce this output:

    0 0 0 1
    0 0 0 0

Notes
-----
Source code built with [platformio](http://platformio.org/#!/), a cross-platform command-line based build tool and dependency manager.

Related Reading
---------------
* [example Python serial application](http://eli.thegreenplace.net/2009/08/07/a-live-data-monitor-with-python-pyqt-and-pyserial/)
* [NTP overview](https://en.wikipedia.org/wiki/Network_Time_Protocol#Clock_synchronization_algorithm)
* [Synchronization Explained](http://www.ni.com/white-paper/11369/en/)
* [Precision Time Protocol](https://en.wikipedia.org/wiki/Precision_Time_Protocol)
